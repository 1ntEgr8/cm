#!/usr/bin/env bash

# cm add
  # easy way to track new dotfiles
# cm rm
  # easy way to remove file from dotfiles repo
# cm edit
  # easy way to edit file in dotfiles repo
# cm install [formulae]
  # if no formulae passed, all
# cm uninstall [formulae]
  # if no formulate passed, all
  # print warning before doing it
# cm commit
  # easy way to commit changes
# cm diff
  # easy way to view changes

# source installation env
source ./env

function help_text() {
  echo "help"
}

function handle_add() {
  case $1 in
    -f|--formula)
      shift
      
      if [[ $# -eq 0 ]]; then
        error "missing formula"
      fi
      
      formula_dir=$1
      formula=$formula_dir/formula
      
      if [[ -e $formula ]]; then
        info "formula $formula_dir exists"
        exit 0
      fi

      mkdir -p $formula_dir
      touch $formula

      cp ./templates/formula_template $formula
      
      info "created formula $formula_dir"
      ;;
    -*)
      error "invalid flag" $1
      ;;
    *)
      if [[ $# -lt 2 ]]; then
        error "insufficient arguments"
      fi
      
      config_file=$1
      formula=$2
      relative_link_path=$formula/$(basename $config_file)
      
      if [[ ! -e $config_file ]]; then
        error "config file $config_file does not exist"
      fi

      if [[ ! -e ./links ]]; then
        touch links
      fi

      if [[ -e $formula/$(basename $config_file) ]]; then
        error "config file $config_file already being tracked"
      fi

      # copy config file to formula
      cp $config_file $formula

      out=$(grep -F "$relative_link_path" links)
      if [[ $? -eq 0 ]]; then
        echo $out
        error "a link already exists"
      fi
      
      # create temp edit file
      touch EDITLINK
      cp ./templates/add_link EDITLINK

      # replace first line of template with partially complete link
      sed -i "" "1 s|.*|FIXME -> $relative_link_path|" EDITLINK

      # read link from user
      vim EDITLINK
      new_link=$(head -n 1 EDITLINK)
      rm EDITLINK 

      # append link
      echo $new_link >> links
      
      # perform the link
      parts=($new_link)
      src=${parts[2]}
      target="${parts[0]}"
      echo $src
      echo $target
      # ln -svf $(pwd)/$src $target
      ;;
  esac
}

function handle_edit() {
  if [[ $# -eq 0 ]]; then
    error "missing formula name"
  fi

  if [[ ! -e $1/formula ]]; then
    error "formula doesn't exist"
  fi

  vim $1/formula
}

function handle_install() {
  formulae=$(find . -type f -name formula)

  # make formulae executable
  chmod +x $formulae
  
  for formula in $formulae; do
    $formula install
    $formula configure
  done
}

if [[ $# -eq 0 ]]; then
  help_text
fi

case $1 in
  add)
    shift
    handle_add $@
    ;;
  rm)
    ;;
  edit)
    shift
    handle_edit $@
    ;;
  install)
    shift
    handle_install $@
    ;;
  commit)
    ;;
  diff)
    ;;
  *)
    help_text
    ;;
esac
